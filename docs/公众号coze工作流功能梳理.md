
## 功能介绍
关于 mp 目录下的工作流代码功能介绍：

### mp/article_rewrite_and_upload_mp.txt

#### 工作流核心功能
这个工作流的主要目的是**实现公众号文章的智能仿写和自动发布**，从输入原始文章链接到最终推送到微信公众号草稿箱的完整自动化流程。

#### 详细流程梳理

##### 1. 内容获取阶段
- **根据链接获取内容**(`LinkReaderPlugin`)：
  - 输入公众号文章地址
  - 自动解析网页内容，提取标题和正文
  - 支持多种格式：网页、PDF、DOC、DOCX、XLSX、CSV、TXT
  - 处理部分网站的访问限制

- **获取网页图片**(`getUrlImg`)：
  - 爬取文章中的所有配图
  - 提取图片URL列表
  - 为后续图片处理做准备

##### 2. 内容仿写阶段
- **仿写爆文**(`豆包大模型`)：
  - 使用豆包1.5 Pro 32k模型进行文章仿写
  - 集成专业插件：`copy_imitation`（全网平台文案仿写）和`title_plugin`（标题优化）
  - 输出优化后的标题和仿写内容
  - 支持去重处理和去AI化处理

##### 3. 图片处理阶段
- **图片链接过滤**(`过滤空图片url`)：
  - 过滤空值、null、undefined的图片URL
  - 将HTTP链接转换为HTTPS
  - 确保图片链接的有效性

- **图片上传循环处理**：
  - 循环处理每张图片，最多处理10张
  - 判断是否为微信图片链接（包含`mmbiz.qpic.cn`）
  - 对非微信图片进行上传转换(`upload_img`)
  - 获取微信内部图片URL

- **图片插入文章**(`图片插入文章`)：
  - 使用豆包1.5 Pro 256k模型
  - 将处理后的图片链接按正确的markdown格式插入文章
  - 确保图片格式为`![描述](链接)`，避免格式错误
  - 智能分布图片位置，保持文章流畅性

##### 4. 格式转换阶段
- **Markdown转HTML**(`md2html`)：
  - 将仿写后的markdown文章转换为微信公众号可识别的HTML格式
  - 使用"蓝青"配色主题
  - 采用无衬线字体
  - 转换效果优化，适配微信公众号样式

##### 5. 封面图片处理
- **首图选择**(`首图`)：
  - 从处理后的图片中选择第一张作为封面
  - 如果没有图片，使用默认封面图片
  - 通过变量聚合确保封面图片的可用性

##### 6. 微信发布阶段
- **Token获取**：调用`getWeixinMpToken`子工作流获取有效token
- **素材上传**(`wx_material_upload`)：将封面图片上传为素材，获取media_id
- **推送到草稿箱**(`wx_upload_article`)：将完整文章推送到微信公众号草稿箱

#### 输入参数

工作流需要以下输入参数：
- `articleUrl`：原始文章链接地址
- `account`：微信公众号账号名称
- `defaultCoverImg`：默认封面图片URL（备用）

#### 输出结果

- `media_id`：草稿箱中文章的媒体ID
- `message`：操作结果消息

#### 核心特点

1. **端到端自动化**：从原始链接到发布草稿的完整自动化流程
2. **智能内容处理**：
   - AI仿写去重，避免版权问题
   - 图片智能插入，保持文章美观
   - 格式自动转换，适配微信公众号
3. **容错机制完善**：
   - 图片获取失败时使用默认封面
   - 多重选择器处理各种异常情况
   - 循环处理确保图片上传成功
4. **模块化设计**：调用独立的token管理工作流，职责分离清晰

#### 技术亮点

- **AI集成**：集成多个专业AI插件，提升仿写质量
- **图片处理优化**：
  - 智能判断微信图片链接，避免重复上传
  - HTTP到HTTPS自动转换
  - 空值过滤确保链接有效性
- **循环处理**：使用循环节点批量处理图片，最多支持10张
- **格式适配**：专门的markdown到微信HTML转换，确保显示效果
- **条件分支**：多个选择器实现复杂的业务逻辑判断

#### 使用场景

这个工作流特别适合：
- 自媒体内容创作者快速产出原创文章
- 内容运营团队批量处理和发布文章
- 自动化内容聚合和分发系统
- 减少人工复制粘贴，提高发布效率
- 内容二次创作和版权规避

#### 工作流优势

1. **效率提升**：将原本需要数小时的人工操作缩短至几分钟
2. **质量保证**：AI仿写确保内容原创性，避免版权纠纷
3. **格式统一**：自动化格式转换，确保发布效果一致
4. **错误处理**：完善的异常处理机制，确保流程稳定性

整个工作流实现了从原始文章到微信公众号草稿箱的完整自动化转换，是一个高效、智能的内容创作和发布解决方案。

### mp/get_wx_mp_token.txt

#### 工作流核心功能
这个工作流的主要目的是**智能获取和管理微信公众号的access_token**，确保token始终有效可用。

#### 详细流程梳理

##### 1. 数据库查询阶段
- **根据公众号名称查询token**：从数据库表`weixin_mp_info`中查询指定账号的相关信息
- 查询内容包括：`app_id`、`app_secret`、`token`、`update_time`、`test_upload_url`

##### 2. Token有效性判断
- **判断数据库是否已有token**：检查查询结果是否包含有效的token记录
- **时间差计算**：比较当前时间与token更新时间，判断是否在有效期内（100分钟内）

##### 3. Token获取策略
根据不同情况采用不同的获取策略：

###### 情况1：数据库无token或token为空
- 直接调用微信API获取新的access_token
- 更新数据库中的token和时间戳

###### 情况2：数据库有token但已过期
- 重新调用微信API获取新的access_token
- 更新数据库记录

###### 情况3：数据库有token且在有效期内
- 通过上传测试图片验证token是否真实有效
- 如果验证失败，重新获取token

##### 4. 数据库更新
- **更新数据**：将新获取的token和当前时间更新到数据库
- **重新更新数据表token**：处理token获取失败的情况

##### 5. 结果聚合
- **变量聚合**：将不同分支获取到的token进行合并输出
- 确保最终输出一个有效的access_token

#### 核心特点

1. **智能缓存机制**：避免频繁调用微信API，减少接口调用次数
2. **多重验证**：不仅检查时间有效性，还通过实际API调用验证token可用性
3. **容错处理**：包含多个分支处理各种异常情况
4. **自动更新**：token过期或失效时自动重新获取并更新数据库

#### 技术亮点

- **时间管理**：使用UTC+8时区获取准确的时间戳
- **条件分支**：通过多个选择器实现复杂的逻辑判断
- **数据持久化**：使用数据库存储token信息，避免重复获取
- **API验证**：通过上传图片接口验证token的实际可用性

这个工作流很好地解决了微信公众号开发中token管理的痛点，实现了高效、稳定的token获取和维护机制。

### mp/upload_to_wx_mp.txt

#### 工作流核心功能
这个工作流的主要目的是**将文章内容和图片上传到微信公众号草稿箱**，实现自动化的公众号内容发布准备。

#### 详细流程梳理

##### 1. Token获取阶段
- **调用getWeixinMpToken工作流**：通过子工作流获取有效的微信公众号access_token
- 输入参数：公众号账号名称(`account`)
- 输出：有效的token用于后续API调用

##### 2. 图片处理阶段
- **上传图片到微信服务器**(`upload_img`)：
  - 将外部图片URL上传到微信公众号服务器
  - 获取微信内部图片URL，用于文章内容中的图片引用
  - 支持jpg/png格式，大小限制1MB以下
  - 不占用公众号素材库的10万张图片限制

##### 3. 封面图片处理
- **获取公众号首图ID**(`wx_material_upload`)：
  - 将处理后的图片上传为素材
  - 获取media_id，用作文章封面图片
  - 上传到公众号素材库管理

##### 4. 文章发布阶段
- **推送文章到草稿箱**(`wx_upload_article`)：
  - 将完整的文章内容发布到公众号草稿箱
  - 包含标题、内容、封面图片等完整信息
  - 生成草稿，等待后续人工审核发布

#### 输入参数

工作流需要以下输入参数：
- `account`：公众号账号名称
- `content`：文章内容（HTML格式）
- `title`：文章标题
- `imageUrl`：封面图片URL

#### 输出结果

- `media_id`：草稿箱中文章的媒体ID
- `message`：操作结果消息

#### 核心特点

1. **完整的发布流程**：从token获取到最终草稿箱发布的完整链路
2. **图片处理优化**：
   - 先上传图片获取微信内部URL
   - 再将图片作为素材上传获取media_id
   - 确保图片在文章中正常显示
3. **模块化设计**：调用独立的token管理工作流，职责分离清晰
4. **错误处理**：各个节点都有错误处理机制，确保流程稳定性

#### 技术亮点

- **子工作流调用**：复用token管理逻辑，避免重复开发
- **图片双重处理**：既处理文章内图片，又处理封面图片
- **API链式调用**：多个微信API按顺序调用，确保数据流转正确
- **参数传递优化**：通过引用方式传递参数，避免数据冗余

#### 使用场景

这个工作流特别适合：
- 自动化内容发布系统
- 批量文章处理和上传
- 内容管理系统与微信公众号的集成
- 减少人工操作，提高发布效率

整个流程实现了从外部内容到微信公众号草稿箱的完整自动化转换，大大提升了内容发布的效率和准确性。

### mp/simple_article_rewrite.txt

#### 工作流核心功能
这个工作流的主要目的是**实现公众号文章的简单仿写和格式转换**，专注于内容的智能改写，是一个轻量级的文章仿写解决方案。

#### 详细流程梳理

##### 1. 内容获取阶段
- **根据链接获取内容**(`LinkReaderPlugin`)：
  - 输入公众号文章地址(`url`)
  - 自动解析网页内容，提取标题和正文
  - 支持多种格式：网页、PDF、DOC、DOCX、XLSX、CSV、TXT
  - 处理部分网站的访问限制，获取完整文章数据
  - 输出：`data.content`（文章内容）、`data.title`（文章标题）

##### 2. 内容仿写阶段
- **仿写爆文**(`豆包大模型`)：
  - 使用豆包1.5 Pro 32k模型进行智能仿写
  - 集成专业插件：
    - `copy_imitation`（全网平台文案仿写）
    - `title_plugin`（标题优化）
  - 温度设置0.8，最大token 4096
  - 输出JSON格式结果，包含优化后的标题和仿写内容

##### 3. 格式转换阶段
- **Markdown转HTML**(`md2html`)：
  - 将仿写后的markdown文章转换为微信公众号可识别的HTML格式
  - 使用"蓝青"(`lanqing`)配色主题
  - 采用无衬线字体(`no-cx`)
  - 转换效果优化，完全适配微信公众号样式要求

#### 输入参数

工作流需要以下输入参数：
- `url`：原始文章链接地址

#### 输出结果

- `data`：转换后的HTML格式文章内容
- `success`：转换成功状态
- `error`：错误信息（如有）

#### 核心特点

1. **简化流程**：专注于核心的仿写功能，流程简洁高效
2. **智能仿写**：
   - AI驱动的内容改写，确保原创性
   - 专业插件支持，提升仿写质量
   - 去重处理和去AI化处理
3. **格式适配**：直接输出微信公众号可用的HTML格式
4. **轻量级设计**：不涉及图片处理和发布功能，专注内容转换

#### 仿写策略

根据系统提示词，工作流采用以下仿写策略：

##### 标题优化
- 控制在20个字以内
- 具备传播力和点击冲动
- 使用专业标题优化插件

##### 内容仿写规则
1. **段落控制**：每个段落1-2句话，保持简短和节奏感
2. **信息清理**：去除作者署名、免责声明、发布时间等无关信息
3. **观点表达**：清晰坚定地表达主观观点，展现自信
4. **语言风格**：采用口语化表达，贴近读者生活
5. **情感共鸣**：使用生动描述和感染力语言引发共鸣
6. **修辞技巧**：恰当运用反问句增强语气和感染力
7. **逻辑连贯**：确保段落间逻辑清晰、过渡自然

##### 去AI化处理
1. **个性化表达**：加入"梦想哥认为"、"梦想哥想"等个性化说法
2. **标点优化**：每两句话将句号换为逗号，增加自然感

#### 质量检验标准

- **传播力测试**：标题是否具备点击冲动
- **情感共鸣测试**：内容是否能引发强烈情感反应
- **分享价值测试**：读者是否愿意主动转发分享
- **易读性测试**：语言是否通俗易懂，节奏是否流畅
- **内容充实度测试**：是否保留原文核心信息与深度
- **篇幅合理性测试**：文章字数是否达到1200-2500字要求

#### 技术亮点

- **AI插件集成**：集成专业的文案仿写和标题优化插件
- **模型优化**：使用豆包1.5 Pro 32k，确保长文本处理能力
- **格式转换**：专门的微信公众号HTML转换，确保显示效果
- **JSON输出**：结构化输出，便于后续处理和集成

#### 使用场景

这个工作流特别适合：
- 个人自媒体创作者快速改写文章
- 内容运营需要批量处理文章内容
- 学习和研究文章仿写技巧
- 作为更复杂工作流的子模块使用
- 简单的内容二次创作需求

#### 与完整版的区别

相比`article_rewrite_and_upload_mp.txt`，这个简化版本：
- **专注内容**：只处理文章仿写，不涉及图片和发布
- **流程简化**：3个节点完成核心功能，易于理解和维护
- **快速执行**：减少了复杂的图片处理和上传步骤
- **灵活使用**：可以作为独立工具或其他工作流的组件

整个工作流实现了从原始文章链接到仿写HTML内容的快速转换，是一个高效、专业的文章仿写工具。